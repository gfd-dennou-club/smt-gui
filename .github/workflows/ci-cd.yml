name: CI/CD

on:
    pull_request: # Runs whenever a pull request is created or updated (including from another fork)
    push: # Runs whenever a commit is pushed to the repository...
        branches: [main, master, develop, hotfix/*] # ...on any of these branches
    workflow_dispatch: # Allows you to run this workflow manually from the Actions tab
concurrency:
    group: "${{ github.workflow }} @ ${{ github.head_ref || github.ref }}"
    cancel-in-progress: true

permissions:
    contents: write # publish a GitHub release
    pages: write # deploy to GitHub Pages
    issues: write # comment on released issues
    pull-requests: write # comment on released pull requests

jobs:
    ci-cd:
        runs-on: ubuntu-latest
        env:
            DETECT_CHROMEDRIVER_VERSION: "true"
            JEST_JUNIT_OUTPUT_DIR: test-results
            NODE_OPTIONS: --max-old-space-size=4000
        steps:
            - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
            - uses: actions/setup-node@26961cf329f22f6837d5f54c3efd76b480300ace # v4
              with:
                  cache: "npm"
                  node-version-file: ".nvmrc"
            - name: Info
              run: |
                  cat <<EOF
                  Node version: $(node --version)
                  NPM version: $(npm --version)
                  GitHub ref: ${{ github.ref }}
                  GitHub head ref: ${{ github.head_ref }}
                  EOF
            - name: Install Dependencies
              run: npm ci
            - name: Build scratch-vm for smalruby
              run: npm run setup-scratch-vm
            - name: Lint
              if: |
                (!(
                  github.ref == 'refs/heads/develop' ||
                  github.ref == 'refs/heads/master' ||
                  github.ref == 'refs/heads/main'
                ))
              run: npm run test:lint
            - name: Run Unit Tests
              if: |
                (!(
                  github.ref == 'refs/heads/develop' ||
                  github.ref == 'refs/heads/master' ||
                  github.ref == 'refs/heads/main'
                ))
              env:
                  JEST_JUNIT_OUTPUT_NAME: unit-results.xml
                  JEST_JUNIT_OUTPUT_DIR: test-results/unit
              run: npm run test:unit -- --reporters="default" --reporters="jest-junit" --coverage --coverageReporters=text --coverageReporters=lcov --maxWorkers="2"
            - name: Run Build
              env:
                NODE_OPTIONS: --max-old-space-size=4000
                NODE_ENV: production
              run: npm run build
            - name: Store Build Output
              uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4
              with:
                name: build-output
                path: ./build
            - name: Store Dist Output
              uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4
              with:
                name: dist-output
                path: ./dist
            - name: Check installed browser
              if: |
                (!(
                  github.ref == 'refs/heads/develop' ||
                  github.ref == 'refs/heads/master' ||
                  github.ref == 'refs/heads/main'
                ))
              run: |
                for F in chrome chromium chromedriver; do
                    which $F && $F --version || echo Not found: $F
                done
            - name: Run Integration Tests
              if: |
                (!(
                  github.ref == 'refs/heads/develop' ||
                  github.ref == 'refs/heads/master' ||
                  github.ref == 'refs/heads/main'
                ))
              env:
                  JEST_JUNIT_OUTPUT_NAME: integration-results.xml
                  JEST_JUNIT_OUTPUT_DIR: test-results/integration
              run: npm run test:integration -- --reporters="default" --reporters="jest-junit"
            - name: Store Test Results
              if: always() # Even if tests fail
              uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4
              with:
                name: test-output
                path: ./test-results/* # Both unit and integration test results
            - run: |
                if [[ ${{ contains(github.ref, 'hotfix') }} == 'true' ]]; then
                sed -e "s|hotfix/REPLACE|${{ github.ref_name }}|" --in-place release.config.js
                fi
            - name: Deploy playground to Smalruby.app GitHub Pages
              uses: peaceiris/actions-gh-pages@373f7f263a76c20808c831209c920827a82a2847 # v3
              if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
              with:
                deploy_key: ${{ secrets.SMALRUBY_APP_DEPLOY_KEY }}
                publish_dir: ./build
                full_commit_message: "Build for ${{ github.sha }} ${{ github.event.head_commit.message }}"
                cname: smalruby.app
                external_repository: smalruby/smalruby.app
            - name: Rebuild for smalruby3-gui GitHub Pages
              if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
              env:
                NODE_OPTIONS: --max-old-space-size=4000
                NODE_ENV: production
                PUBLIC_PATH: /smalruby3-gui/
              run: |
                npm run build
                # Fix worker-loader paths for smalruby3-gui deployment
                sed -i 's|return "chunks/" + "fetch-worker"|return "/smalruby3-gui/chunks/" + "fetch-worker"|g' build/gui.js build/player.js
            - name: Deploy playground to GitHub Pages
              uses: peaceiris/actions-gh-pages@373f7f263a76c20808c831209c920827a82a2847 # v3
              if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
              with:
                github_token: ${{ secrets.GITHUB_TOKEN }}
                publish_dir: ./build
                full_commit_message: "Build for ${{ github.sha }} ${{ github.event.head_commit.message }}"
            - name: Set branch name
              id: branch
              run: echo "BRANCH_NAME=${{ github.head_ref || github.ref_name }}" >> $GITHUB_OUTPUT
            - name: Rebuild for branch GitHub Pages
              if: |
                (!(
                  github.ref == 'refs/heads/develop' ||
                  github.ref == 'refs/heads/master' ||
                  github.ref == 'refs/heads/main' ||
                  startsWith(github.ref, 'refs/heads/hotfix/') ||
                  startsWith(github.ref, 'refs/heads/dependabot/') ||
                  startsWith(github.ref, 'refs/heads/renovate/')
                ))
              env:
                NODE_OPTIONS: --max-old-space-size=4000
                NODE_ENV: production
                PUBLIC_PATH: /smalruby3-gui/${{ steps.branch.outputs.BRANCH_NAME }}/
              run: |
                npm run build
                # Fix worker-loader paths for branch deployment
                sed -i 's|return "chunks/" + "fetch-worker"|return "/smalruby3-gui/${{ steps.branch.outputs.BRANCH_NAME }}/chunks/" + "fetch-worker"|g' build/gui.js build/player.js
            - name: Deploy playground to GitHub Pages for branch
              if: |
                (!(
                  github.ref == 'refs/heads/develop' ||
                  github.ref == 'refs/heads/master' ||
                  github.ref == 'refs/heads/main' ||
                  startsWith(github.ref, 'refs/heads/hotfix/') ||
                  startsWith(github.ref, 'refs/heads/dependabot/') ||
                  startsWith(github.ref, 'refs/heads/renovate/')
                ))
              uses: peaceiris/actions-gh-pages@373f7f263a76c20808c831209c920827a82a2847 # v3
              with:
                github_token: ${{ secrets.GITHUB_TOKEN }}
                publish_dir: ./build
                full_commit_message: "Build for ${{ steps.branch.outputs.BRANCH_NAME }} (${{ github.sha }}) ${{ github.event.head_commit.message }}"
                destination_dir: ${{ steps.branch.outputs.BRANCH_NAME }}
                keep_files: true
